<%include ./static/header.ejs %>
<%include ./static/sidebar.ejs%>
<%include ./static/navbar.ejs%>

<!-- Begin Page Content -->
<div class="container-fluid">

  <!-- Page Heading -->

  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-12 d-none d-sm-block">
        <h2>
          Captura De Seriales Por Ubicaci√≥n
        </h2>
        <hr>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-6">
        <div class="row">
          <div class=" col-lg-2 d-none d-sm-block">
            <label for=""> Ubicacion:</label>
            <input type="text" class="form-control" name="" id="ub" aria-describedby="helpId" placeholder=""
              value="<%= ubicacion %>" readonly>

          </div>
          <div class=" col-lg-3 d-none d-sm-block">
            <label for=""> Captura No:</label>
            <input type="text" class="form-control" name="" id="ca" aria-describedby="helpId" placeholder=""
              value="<%= captura_grupo %>" readonly>

          </div>
          <div class=" col-lg-7 d-none d-sm-block">
            <label for=""> Nombre de empleado:</label>
            <input type="text" class="form-control" name="" id="no" aria-describedby="helpId" placeholder=""
              value="<%= nombreContador %>" readonly>

          </div>
        </div>
        <div class="row">
          <div class="col-lg-12">

            <label>
              <label>Serial:
                <span class="badge badge-warning " id="serialWarning" hidden>
                  <span class="badge badge-danger fas fa-exclamation-triangle" style="font-size: 10px;">
                  </span>
                  <span id="serialWarning2" style="font-size: 15px ; color:black" hidden>
                    Incorrecto
                  </span>
                </span>
              </label>
            </label>

            <div class="input-group  col-lg-12">

              <div class="input-group-prepend ">
                <span class="animated jello slow cdelay-2 input-group-text bg-secondary text-white"
                  id="basic-addon1"><span class="fas fa-barcode"></span></span>
              </div>
              <input oninput="this.value = this.value.toUpperCase()" type="text" name="serial" id="serial"
                class="form-control" placeholder="Serial" aria-describedby="helpId" required>

            </div>

          </div>
        </div>
      </div>
      <div class="col-lg-2">

        <div class="card">
          <div class="card-header bg-secondary text-white text-center font-weight-bold"> Terminar Captura</div>
          <div class="card-body text-center">

            <button type="button" name="modalCaptura" id="modalCaptura" class="btn btn-primary btn-lg  "
              data-toggle="modal" data-target="#exampleModal"><span class="fas fa-clipboard-check"
                style="font-size: 50px;"></span></button>
          </div>
        </div>

        <!-- Modal -->
        <div class="modal" tabindex="-1" role="dialog" id="exampleModal">
          <div class="modal-dialog" role="document">
            <div class="modal-content  ">
              <div class="modal-header">
                <h4 class="modal-title ">Captura No: <span
                    class="badge border-bottom-primary"><%= captura_grupo%></span> </h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body text-center">

                <input type="text" class="form-control" name="captura_actual" id="captura_actual"
                  aria-describedby="helpId" placeholder="" value="<%= captura_actual%>" hidden>

                <div class="card" id="serialesObsoletosRow" hidden>
                  <div class="card-header bg-danger text-white text-center font-weight-bold"> Apartar Seriales Obsoletos
                  </div>
                  <div class="card-body text-center">
                    <div class="row">
                      <div class="col-lg-12 text-center">
                        <div id="spanObsoletos">
                          <!-- Se hace append desde Jquery -->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>



                <label>
                  <label>Seriales Contados:
                    <span class="badge badge-warning " id="contadorWarning" hidden>
                      <span class="badge badge-danger fas fa-exclamation-triangle" style="font-size: 10px;">
                      </span>
                      <span id="contadorWarning2" style="font-size: 15px ; color:black" hidden>
                        Cantidad Incorrecta
                      </span>
                    </span>
                  </label>
                </label>


                <div class="row">

                  <div class="col-lg-6 col- text-center">
                    <div class="value-button" id="decrease" onclick="decreaseValue()" value="Decrease Value"><span
                        class="fas fa-minus-circle text-warning" style="font-size: 65px"></span></div>
                  </div>
                  <div class="col-lg-6  col- text-center">
                    <div class="value-button" id="increase" onclick="increaseValue()" value="Increase Value"><span
                        class="fas fa-plus-circle text-success" style="font-size: 65px"></span></div>
                  </div>

                </div>
                <br>
                <div class="row">
                  <div class="col-lg-12 text-center">
                    <div class="">
                      <input type="number" class="form-control" name="contadorSeriales" id="contadorSeriales" value="0">
                    </div>
                  </div>
                </div>
              </div>

              <form action="/conteo_guardar" method="POST">

                <input type="text" class="form-control" name="gafete" id="gafete" aria-describedby="helpId"
                  placeholder="" value="<%=gafete%>" hidden>

                <input type="text" class="form-control" name="seriales" id="seriales" aria-describedby="helpId"
                  placeholder="" value="" hidden>
                <input type="text" class="form-control" name="serialesObsoletos" id="serialesObsoletos"
                  aria-describedby="helpId" placeholder="" value="" hidden>
                <input type="text" class="form-control" name="nombreContador" id="nombreContador"
                  aria-describedby="helpId" placeholder="" value="<%= nombreContador%>" hidden>
                <input type="text" class="form-control" name="ubicacion" id="ubicacion" aria-describedby="helpId"
                  placeholder="" value="<%= ubicacion%>" hidden>
                <input type="text" class="form-control" name="captura_grupo" id="captura_grupo"
                  aria-describedby="helpId" placeholder="" value="<%= captura_grupo%>" hidden>

                <div class="modal-footer">
                  <button type="submit" class="btn btn-success btn-block" id="btnCapturar">Capturar</button>
                </div>
              </form>

            </div>
          </div>
        </div>
        <!--/ Modal -->

      </div>
      <div class="col-lg-4 d-none d-sm-block">
        <div class="col-lg-12">
          <div>
            <div class="card">
              <div class="card-header bg-secondary text-white text-center"><strong id="date"></strong></div>
              <div class="card-body">
                <img src="/img/warehouse.jpg" alt="Warehouse Image" class="img-fluid">
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Collapse -->
    <div class="col-lg-12 mt-2 ">

      <div class="card shadow mb-4 shadow-lg">
        <div class="card-header py-3 bg-secondary">
          <h3 class="text-white">Capturado</h3>
        </div>
        <div class="accordion" id="accordionExample">

          <div class="card-body" id="cardCapturado">
            <!-- Seriales Capturados agregados por Jquery -->
          </div>

        </div>
      </div>
    </div>
    <!-- /Collapse -->

    <!-- /.container-fluid -->
  </div>
  <!-- End of Main Content -->

  <% include ./static/footer.ejs%>

  <script>

    function disableF5(e) { if ((e.which || e.keyCode) == 116 || (e.which || e.keyCode) == 82) e.preventDefault(); };

    $(document).ready(function () {
      $(document).on("keydown", disableF5);
      $('#serial').focus()
      soundOk()
    });

    serialesCapturados = <%- JSON.stringify(serialesCapturados) %>;
    storage_units = <%- JSON.stringify(storage_units) %>;
    let items = [];
    let itemsObsoletos = [];

    let currentDate = new Date(),
      day = currentDate.getDate(),
      month = currentDate.getMonth() + 1,
      year = currentDate.getFullYear(),
      date = day + "/" + month + "/" + year;

    document.getElementById("date").innerHTML = date;


    /////////////////////////////// Modal ////////////////////////////////////////////////
    $('#myModal').on('shown.bs.modal', function () {
      $('#myInput').trigger('focus')
    })

    function increaseValue() {
      let value = parseInt(document.getElementById('contadorSeriales').value, 10);
      value = isNaN(value) ? 0 : value;
      value++;
      document.getElementById('contadorSeriales').value = value;
    }

    function decreaseValue() {
      let value = parseInt(document.getElementById('contadorSeriales').value, 10);
      value = isNaN(value) ? 0 : value;
      value < 1 ? value = 1 : '';
      value--;
      document.getElementById('contadorSeriales').value = value;
    }

    modalCaptura.addEventListener("click", function (e) {

      if (itemsObsoletos.length != 0) {

        $('#serialesObsoletosRow').removeAttr('hidden')
        for (let i = 0; i < itemsObsoletos.length; i++) {
          $("#spanObsoletos").append(`<span class="badge badge-danger"> ${itemsObsoletos[i]} </span>`);
          $("#spanObsoletos").append(` `);
        }
      }
    });
    //Si el modal se cierra borra todos los append de la funcion de arriba
    $('#exampleModal').on('hidden.bs.modal', function () {
      $("#spanObsoletos").empty()
    })

    /////////////////////////////// Modal ////////////////////////////////////////////////


    $('#serial').keypress(function (e) {

      if (e.which == 13) {
        e.preventDefault()
        serialFunction()
        $('#serial').val("")
      }
    })



    function guardarNumeros(tipo) {

      let color
      serialVal = document.getElementById('serial').value;
      if (tipo == 'activo') {
        items.push(serialVal.substr(1));
        color = 'success'
        $('#seriales').val(`${items}`)
      } else {
        itemsObsoletos.push(serialVal.substr(1));
        color = 'danger'
        $('#serialesObsoletos').val(`${itemsObsoletos}`)
      }

      $('#gafete').val(`${items}`)
      let addSpan = `<span class="badge badge-${color} fspan">${serialVal.substr(1)}</span> `
      $('#cardCapturado').append(addSpan)


      return false; // stop submission
    }


    function serialFunction() {
      let serial = $('#serial').val();
      let encontrado = false;


      if (serial.charAt(0) == "S" && Number.isInteger(parseInt(serial.substr(1)))) {

        for (let i = 0; i < serialesCapturados.length; i++) {

          if (serial.substr(1) == serialesCapturados[i].serial) {

            encontrado = true;
            soundWrong()
            $('#serialWarning').removeAttr('hidden')
            $('#serialWarning2').text('Serial Duplicado')
            $('#serialWarning2').removeAttr('hidden')
            $('#serial').val('')
            break;
          }
        }
        for (let y = 0; y < items.length; y++) {
          if (serial.substr(1) == items[y]) {

            encontrado = true;
            soundWrong()
            $('#serialWarning').removeAttr('hidden')
            $('#serialWarning2').text('Serial Duplicado')
            $('#serialWarning2').removeAttr('hidden')
            $('#serial').val('')
            break;
          }

        }
        for (let x = 0; x < itemsObsoletos.length; x++) {
          if (serial.substr(1) == itemsObsoletos[x]) {

            encontrado = true;
            soundWrong()
            $('#serialWarning').removeAttr('hidden')
            $('#serialWarning2').text('Serial Duplicado')
            $('#serialWarning2').removeAttr('hidden')
            $('#serial').val('')
            break;
          }

        }
        if (encontrado == false) {
          let SerialExistente = false
          for (let y = 0; y < storage_units.length; y++) {

            if (serial.substr(1) == storage_units[y].storage_unit) {
              SerialExistente = true
              break
            }
          }


          if (SerialExistente == true) {
            guardarNumeros('activo')
          } else {
            guardarNumeros('obsoleto')
          }

          soundOk()
          //$('form#submitSerial').submit();
          $('#serialWarning').prop('hidden', true)
          $('#serialWarning2').prop('hidden', true)
        }

      } else {
        soundWrong()
        $('#serialWarning').removeAttr('hidden')
        $('#serialWarning2').text('Incorrecto')
        $('#serialWarning2').removeAttr('hidden')
        $('#serial').val('')
      }

    }


    btnCapturar.addEventListener("click", function (e) {

      let cantidad = $('#contadorSeriales').val();

      if (cantidad == (items.length + itemsObsoletos.length)) {

        $('#contadorWarning').prop('hidden', true)
        $('#contadorWarning2').prop('hidden', true)
        soundOk()
        console.log("bien");

      } else {
        e.preventDefault()
        console.log("mal");


        $('#contadorWarning').removeAttr('hidden')
        $('#contadorWarning2').removeAttr('hidden')
        soundWrong()

      }
    });








  </script>